"use strict";(globalThis.webpackChunkcoo_llm_docs=globalThis.webpackChunkcoo_llm_docs||[]).push([[8361],{6494:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>t,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"Reference/Storage","title":"Storage","description":"COO-LLM uses pluggable storage backends for runtime metrics and caching. The system supports Redis, in-memory, HTTP API, and file-based storage.","source":"@site/content/Reference/Storage.md","sourceDirName":"Reference","slug":"/Reference/Storage","permalink":"/docs/docs/Reference/Storage","draft":false,"unlisted":false,"editUrl":"https://github.com/coo-llm/coo-llm-main/tree/main/docs/content/content/Reference/Storage.md","tags":[{"inline":true,"label":"developer-guide","permalink":"/docs/docs/tags/developer-guide"},{"inline":true,"label":"storage","permalink":"/docs/docs/tags/storage"}],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4,"tags":["developer-guide","storage"]},"sidebar":"tutorialSidebar","previous":{"title":"Load Balancer","permalink":"/docs/docs/Reference/Balancer"},"next":{"title":"Logging","permalink":"/docs/docs/Reference/Logging"}}');var i=r(4848),l=r(8453);const t={sidebar_position:4,tags:["developer-guide","storage"]},o="Storage",c={},d=[{value:"Storage Interface",id:"storage-interface",level:2},{value:"Supported Backends",id:"supported-backends",level:2},{value:"Redis Storage (Production)",id:"redis-storage-production",level:3},{value:"In-Memory Storage (Development)",id:"in-memory-storage-development",level:3},{value:"HTTP API Storage",id:"http-api-storage",level:3},{value:"File Storage",id:"file-storage",level:3},{value:"Usage Metrics",id:"usage-metrics",level:2},{value:"Caching",id:"caching",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Runtime Storage",id:"runtime-storage",level:3},{value:"Cache Configuration",id:"cache-configuration",level:3},{value:"Implementation Details",id:"implementation-details",level:2},{value:"Redis Backend",id:"redis-backend",level:3},{value:"Memory Backend",id:"memory-backend",level:3},{value:"HTTP Backend",id:"http-backend",level:3},{value:"File Backend",id:"file-backend",level:3},{value:"Metrics Usage",id:"metrics-usage",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"Production Setup",id:"production-setup",level:3},{value:"Development Setup",id:"development-setup",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Common Issues",id:"common-issues",level:3},{value:"Debug Commands",id:"debug-commands",level:3}];function a(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"storage",children:"Storage"})}),"\n",(0,i.jsx)(n.p,{children:"COO-LLM uses pluggable storage backends for runtime metrics and caching. The system supports Redis, in-memory, HTTP API, and file-based storage."}),"\n",(0,i.jsx)(n.h2,{id:"storage-interface",children:"Storage Interface"}),"\n",(0,i.jsxs)(n.p,{children:["All storage backends implement the ",(0,i.jsx)(n.code,{children:"RuntimeStore"})," interface from ",(0,i.jsx)(n.code,{children:"internal/store/interface.go"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type RuntimeStore interface {\n    GetUsage(provider, keyID, metric string) (float64, error)\n    SetUsage(provider, keyID, metric string, value float64) error\n    IncrementUsage(provider, keyID, metric string, delta float64) error\n    GetUsageInWindow(provider, keyID, metric string, windowSeconds int64) (float64, error)\n    SetCache(key, value string, ttlSeconds int64) error\n    GetCache(key string) (string, error)\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"supported-backends",children:"Supported Backends"}),"\n",(0,i.jsx)(n.h3,{id:"redis-storage-production",children:"Redis Storage (Production)"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Configuration:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'storage:\n  runtime:\n    type: "redis"\n    addr: "localhost:6379"\n    password: "${REDIS_PASSWORD}"\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Features:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Persistent storage for metrics"}),"\n",(0,i.jsx)(n.li,{children:"High performance with connection pooling"}),"\n",(0,i.jsx)(n.li,{children:"TTL support for automatic cleanup"}),"\n",(0,i.jsx)(n.li,{children:"Used for production deployments"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Data Structure:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Key: usage:{provider}:{key_id}:{metric}\nValue: float64\nTTL: 60 seconds\n\nExamples:\nusage:openai:key1:req \u2192 45.0\nusage:openai:key1:tokens \u2192 1200.0\nusage:openai:key1:errors \u2192 2.0\n"})}),"\n",(0,i.jsx)(n.h3,{id:"in-memory-storage-development",children:"In-Memory Storage (Development)"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Configuration:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'storage:\n  runtime:\n    type: "memory"\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Features:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Fast in-memory storage"}),"\n",(0,i.jsx)(n.li,{children:"No persistence (lost on restart)"}),"\n",(0,i.jsx)(n.li,{children:"Used for development and testing"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"http-api-storage",children:"HTTP API Storage"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Configuration:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'storage:\n  runtime:\n    type: "http"\n    addr: "https://api.example.com/storage"\n    api_key: "${STORAGE_API_KEY}"\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Features:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Remote storage via HTTP API"}),"\n",(0,i.jsx)(n.li,{children:"Useful for centralized metrics storage"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"file-storage",children:"File Storage"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Configuration:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'storage:\n  runtime:\n    type: "file"\n    path: "./storage/data.json"\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Features:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Simple file-based storage"}),"\n",(0,i.jsx)(n.li,{children:"Not recommended for production"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"usage-metrics",children:"Usage Metrics"}),"\n",(0,i.jsx)(n.p,{children:"The system tracks the following metrics per provider/key combination:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"req"}),": Number of requests"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"input_tokens"}),": Input tokens used"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"output_tokens"}),": Output tokens generated"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"tokens"}),": Total tokens used"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"errors"}),": Number of failed requests"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"latency"}),": Average response latency in milliseconds"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"caching",children:"Caching"}),"\n",(0,i.jsx)(n.p,{children:"Response caching is supported when enabled:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"policy:\n  cache:\n    enabled: true\n    ttl_seconds: 10\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Cache Keys:"})," Normalized text prompts\n",(0,i.jsx)(n.strong,{children:"Storage:"})," Same backend as runtime metrics\n",(0,i.jsx)(n.strong,{children:"TTL:"})," Configurable expiration time"]}),"\n",(0,i.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsx)(n.h3,{id:"runtime-storage",children:"Runtime Storage"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'storage:\n  runtime:\n    type: "redis"  # redis, memory, http, file\n    addr: "localhost:6379"\n    password: ""\n    api_key: ""\n'})}),"\n",(0,i.jsx)(n.h3,{id:"cache-configuration",children:"Cache Configuration"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"policy:\n  cache:\n    enabled: true\n    ttl_seconds: 10\n"})}),"\n",(0,i.jsx)(n.h2,{id:"implementation-details",children:"Implementation Details"}),"\n",(0,i.jsx)(n.h3,{id:"redis-backend",children:"Redis Backend"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"File:"})," ",(0,i.jsx)(n.code,{children:"internal/store/redis.go"})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Features:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Uses go-redis client"}),"\n",(0,i.jsx)(n.li,{children:"Automatic TTL management"}),"\n",(0,i.jsx)(n.li,{children:"Atomic increment operations"}),"\n",(0,i.jsx)(n.li,{children:"Connection pooling"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"memory-backend",children:"Memory Backend"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"File:"})," ",(0,i.jsx)(n.code,{children:"internal/store/memory.go"})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Features:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Thread-safe with sync.RWMutex"}),"\n",(0,i.jsx)(n.li,{children:"In-memory map storage"}),"\n",(0,i.jsx)(n.li,{children:"No persistence"}),"\n",(0,i.jsx)(n.li,{children:"Fast for development"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"http-backend",children:"HTTP Backend"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"File:"})," ",(0,i.jsx)(n.code,{children:"internal/store/http.go"})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Features:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"REST API integration"}),"\n",(0,i.jsx)(n.li,{children:"Bearer token authentication"}),"\n",(0,i.jsx)(n.li,{children:"JSON request/response format"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"file-backend",children:"File Backend"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"File:"})," ",(0,i.jsx)(n.code,{children:"internal/store/file.go"})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Features:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"JSON file storage"}),"\n",(0,i.jsx)(n.li,{children:"Simple persistence"}),"\n",(0,i.jsx)(n.li,{children:"Not concurrent-safe"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"metrics-usage",children:"Metrics Usage"}),"\n",(0,i.jsx)(n.p,{children:"Metrics are used for:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Rate Limiting:"})," Check req/min and tokens/min limits"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Load Balancing:"})," Select least-loaded keys"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Monitoring:"})," Track performance and errors"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Caching:"})," Response deduplication"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,i.jsx)(n.h3,{id:"production-setup",children:"Production Setup"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Use Redis for production deployments"}),"\n",(0,i.jsx)(n.li,{children:"Set appropriate TTL values (default 60s)"}),"\n",(0,i.jsx)(n.li,{children:"Monitor Redis memory usage"}),"\n",(0,i.jsx)(n.li,{children:"Implement Redis persistence (RDB/AOF)"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"development-setup",children:"Development Setup"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Use in-memory storage for quick testing"}),"\n",(0,i.jsx)(n.li,{children:"Switch to Redis when testing load balancing"}),"\n",(0,i.jsx)(n.li,{children:"Check logs for storage errors"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,i.jsx)(n.h3,{id:"common-issues",children:"Common Issues"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Redis connection failed:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Test connection\nredis-cli -h localhost -p 6379 ping\n\n# Check Redis logs\ndocker logs redis-container\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Metrics not updating:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Verify storage backend configuration"}),"\n",(0,i.jsx)(n.li,{children:"Check for storage errors in logs"}),"\n",(0,i.jsx)(n.li,{children:"Ensure proper permissions"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"High memory usage:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Monitor Redis memory with ",(0,i.jsx)(n.code,{children:"INFO memory"})]}),"\n",(0,i.jsx)(n.li,{children:"Adjust TTL values if needed"}),"\n",(0,i.jsx)(n.li,{children:"Implement key expiration"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"debug-commands",children:"Debug Commands"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'# View all usage keys\nredis-cli keys "usage:*"\n\n# Get specific metric\nredis-cli get "usage:openai:key1:req"\n\n# Check TTL\nredis-cli ttl "usage:openai:key1:req"\n'})})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>t,x:()=>o});var s=r(6540);const i={},l=s.createContext(i);function t(e){const n=s.useContext(l);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),s.createElement(l.Provider,{value:n},e.children)}}}]);